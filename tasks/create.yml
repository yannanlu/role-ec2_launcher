---
- name: Query facts on the AMI with profile in {{region}}
  ec2_ami_find:
    profile: "{{profile}}"
    region: "{{region}}"
    ami_id: "{{image_id}}"
  when: profile != 'tower'
  register: ami_info_p

- name: Query facts on the AMI with tower in {{region}}
  ec2_ami_find:
    region: "{{region}}"
    ami_id: "{{image_id}}"
  when: profile == 'tower'
  register: ami_info_k

- name: Set the default user for Ubuntu
  set_fact:
    default_user: ubuntu
  when: (ami_info_p.results is defined and ami_info_p.results|length > 0 and ami_info_p.results[0].name is search('ubuntu')) or (ami_info_k.results is defined and ami_info_k.results|length > 0 and ami_info_k.results[0].name is search('ubuntu'))

- name: Set the default user for CentOS
  set_fact:
    default_user: centos
  when: (ami_info_p.results is defined and ami_info_p.results|length > 0 and ami_info_p.results[0].name is search('CentOS')) or (ami_info_k.results is defined and ami_info_k.results|length > 0 and ami_info_k.results[0].name is search('CentOS'))

- name: Create security group with profile in {{region}}
  ec2_group:
    name: "{{sg_name | default(key_name + '_sg')}}"
    description: "A Security group for {{service_tag}} on {{env_tag}}"
    profile: "{{profile}}"
    region: "{{region}}"
    vpc_id: "{{vpc_id}}"
    rules: "{{sg_rules}} + {{extra_sg_rules}}"
    rules_egress:
      - proto: all
        cidr_ip: 0.0.0.0/0
  when: profile != 'tower' and ami_info_p.results|length > 0
  register: basic_sg_p

- name: Create security group with tower in {{region}}
  ec2_group:
    name: "{{sg_name | default(key_name + '_sg')}}"
    description: "A Security group for {{service_tag}} on {{env_tag}}"
    region: "{{region}}"
    vpc_id: "{{vpc_id}}"
    rules: "{{sg_rules}} + {{extra_sg_rules}}"
    rules_egress:
      - proto: all
        cidr_ip: 0.0.0.0/0
  when: profile == 'tower' and ami_info_k.results|length > 0
  register: basic_sg_k

- include: launch_item_with_profile.yml
  with_items: "{{subnet_ids}}"
  loop_control:
    loop_var: subnet_item
  when: profile != 'tower' and basic_sg_p.group_id is defined and ami_info_p.results|length > 0

- include: launch_item_with_tower.yml
  with_items: "{{subnet_ids}}"
  loop_control:
    loop_var: subnet_item
  when: profile == 'tower' and basic_sg_k.group_id is defined and ami_info_k.results|length > 0

- name: Wait for all instances to fullly come up
  wait_for:
    host: "{{item}}"
    port: 22
    state: started
    delay: 60
    sleep: 5
    timeout: "{{wait_for_up}}"
  with_items: "{{groups['ec2hosts']}}"

- name: Set pause time
  set_fact:
    pause_sec: "{{pause_for_up}}"

- name: Adjust pause time
  set_fact:
    pause_sec: "{{ (pause_for_up + 30)|int|abs }}"
  when: groups['ec2hosts']|length > 0 and default_user in ['ec2_user','centos'] 

- name: Pause for a while
  pause:
    seconds: "{{pause_sec}}"
  when: groups['ec2hosts']|length > 0 and pause_sec > 0
